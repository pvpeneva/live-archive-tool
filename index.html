<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8" />
    <meta name="viewport" content="width=device-width, initial-scale=1.0"/>
    <title>Archive Footage Database - Live</title>
    <style>
        * { margin:0; padding:0; box-sizing:border-box; }
        body {
            font-family:-apple-system,BlinkMacSystemFont,'Segoe UI',Roboto,Oxygen,Ubuntu,Cantarell,sans-serif;
            background:linear-gradient(135deg,#667eea 0%,#764ba2 100%);
            min-height:100vh; padding:20px;
        }
        .container {
            max-width:1600px; margin:0 auto; background:#fff; border-radius:16px;
            box-shadow:0 20px 60px rgba(0,0,0,.3); overflow:hidden;
        }

        /* Header */
        .header {
            background:linear-gradient(135deg,#667eea 0%,#764ba2 100%);
            color:#fff; padding:40px 40px 32px 80px; text-align:center; position:relative;
        }
        .header h1 { font-size:2.5em; margin-bottom:6px; }
        .header p { font-size:1.05em; opacity:.95; }

        /* Active name + button (new) */
        .active-sheet-wrap { margin-top:14px; display:flex; flex-direction:column; align-items:center; gap:10px; }
        #activeSheetName {
            font-weight:800; letter-spacing:.2px;
            font-size:1.25em; padding:6px 14px; border-radius:8px;
            background:rgba(255,255,255,.12);
        }
        #openSheetBtn {
            display:none; /* shown only if link exists */
            padding:10px 18px; border:none; border-radius:10px; cursor:pointer;
            font-weight:700; color:#fff;
            background:linear-gradient(135deg,#28a745 0%,#20c997 100%);
            box-shadow:0 6px 18px rgba(32,201,151,.35); transition:transform .2s, box-shadow .2s;
        }
        #openSheetBtn:hover { transform:translateY(-1px); box-shadow:0 10px 22px rgba(32,201,151,.45); }

        .live-indicator{
            position:absolute; top:20px; right:20px; background:rgba(255,255,255,.2);
            padding:10px 20px; border-radius:20px; font-size:.9em; display:flex; align-items:center; gap:8px;
        }
        .live-dot{ width:10px; height:10px; background:#4ade80; border-radius:50%; animation:pulse 2s infinite; }
        .live-dot.error{ background:#ef4444; animation:none; }
        @keyframes pulse{0%,100%{opacity:1}50%{opacity:.5}}

        /* Sidebar */
        .hamburger-menu{ position:absolute; left:20px; top:50%; transform:translateY(-50%);
            width:40px; height:40px; background:rgba(255,255,255,.2); border-radius:8px;
            display:flex; align-items:center; justify-content:center; cursor:pointer; transition:all .3s; z-index:1001;
        }
        .hamburger-menu:hover{ background:rgba(255,255,255,.3); }
        .hamburger-icon{ font-size:1.8em; color:#fff; }

        .sidebar{ position:fixed; left:-350px; top:0; width:350px; height:100vh; background:#fff;
            box-shadow:2px 0 20px rgba(0,0,0,.2); transition:left .3s; z-index:1000; overflow-y:auto; }
        .sidebar.open{ left:0; }
        .sidebar-header{
            background:linear-gradient(135deg,#667eea 0%,#764ba2 100%);
            color:#fff; padding:25px; display:flex; justify-content:space-between; align-items:center;
        }
        .sidebar-content{ padding:20px; }
        .close-btn{
            background:rgba(255,255,255,.2); border:none; color:#fff; width:35px; height:35px; border-radius:50%;
            cursor:pointer; font-size:1.5em; display:flex; align-items:center; justify-content:center; transition:all .3s;
        }
        .close-btn:hover{ background:rgba(255,255,255,.3); }

        .add-sheet-btn{
            width:100%; padding:15px; background:linear-gradient(135deg,#28a745 0%,#20c997 100%);
            color:#fff; border:none; border-radius:8px; font-size:1.05em; font-weight:700; cursor:pointer; margin-bottom:20px; transition:all .3s;
        }
        .add-sheet-btn:hover{ transform:translateY(-2px); box-shadow:0 5px 15px rgba(40,167,69,.4); }

        .helper-box{
            background:#e7f3ff; border-left:4px solid #0066cc; padding:12px; margin-bottom:15px; border-radius:4px; font-size:.85em;
        }
        .sheet-list{ list-style:none; }
        .sheet-item{
            background:#f8f9fa; padding:15px; border-radius:8px; margin-bottom:10px; cursor:pointer; transition:all .3s;
            border-left:4px solid transparent; position:relative;
        }
        .sheet-item:hover{ background:#e9ecef; border-left-color:#667eea; }
        .sheet-item.active{ background:linear-gradient(135deg,rgba(102,126,234,.1) 0%,rgba(118,75,162,.1) 100%); border-left-color:#667eea; }
        .sheet-item-name{ font-weight:700; color:#495057; margin-bottom:5px; font-size:1.05em; }
        .sheet-item-url{ font-size:.8em; color:#6c757d; word-break:break-all; }
        .sheet-item-actions{ position:absolute; right:10px; top:50%; transform:translateY(-50%); display:flex; gap:6px; }
        .action-btn{
            background:rgba(102,126,234,.1); border:none; padding:0 10px; height:30px; border-radius:16px; cursor:pointer; font-size:.85em; transition:all .2s;
        }
        .action-btn:hover{ background:rgba(102,126,234,.2); }
        .action-btn.delete{ background:rgba(239,68,68,.1); }
        .action-btn.delete:hover{ background:rgba(239,68,68,.2); }

        /* Modal */
        .modal{ position:fixed; inset:0; background:rgba(0,0,0,.5); display:none; align-items:center; justify-content:center; z-index:2000; }
        .modal.show{ display:flex; }
        .modal-content{
            background:#fff; padding:30px; border-radius:12px; max-width:600px; width:90%; max-height:90vh; overflow-y:auto;
            box-shadow:0 10px 40px rgba(0,0,0,.3);
        }
        .modal-header{ font-size:1.5em; color:#667eea; margin-bottom:20px; }
        .modal-input{ width:100%; padding:12px; border:2px solid #dee2e6; border-radius:8px; font-size:1em; margin-bottom:12px; }
        .modal-input:focus{ outline:none; border-color:#667eea; }
        .modal-buttons{ display:flex; gap:10px; margin-top:12px; }
        .modal-buttons button{ flex:1; padding:12px; border:none; border-radius:8px; font-weight:700; cursor:pointer; transition:all .3s; }
        .modal-btn-save{ background:#28a745; color:#fff; }
        .modal-btn-cancel{ background:#e9ecef; color:#495057; }

        .overlay{ position:fixed; inset:0; background:rgba(0,0,0,.3); display:none; z-index:999; }
        .overlay.show{ display:block; }

        /* Setup & Controls */
        .toggle-setup{
            background:#fff3cd; border:2px solid #ffc107; padding:15px; margin:20px 30px; border-radius:8px; cursor:pointer;
            text-align:center; font-weight:700; color:#856404;
        }
        .toggle-setup:hover{ background:#ffe69c; }

        .setup-instructions{ background:linear-gradient(135deg,#667eea 0%,#764ba2 100%); color:#fff; padding:30px; margin:30px; border-radius:12px; }
        .setup-instructions h3{ font-size:1.5em; margin-bottom:16px; }
        .setup-step{ background:rgba(255,255,255,.1); padding:18px; border-radius:8px; margin-bottom:12px; }
        .setup-step h4{ margin-bottom:8px; font-size:1.15em; }
        .code-block{
            background:#1e1e1e; color:#d4d4d4; padding:16px; border-radius:8px; font-family:'Courier New',monospace; font-size:.9em; overflow-x:auto; white-space:pre;
        }

        .sheet-config{ padding:30px; background:#f8f9fa; border-bottom:2px solid #e9ecef; }
        .sheet-input-group{ display:flex; gap:10px; margin-bottom:12px; }
        .sheet-input-group input{
            flex:1; padding:14px; border:2px solid #28a745; border-radius:8px; font-size:1em;
        }
        .sheet-input-group button{
            padding:14px 24px; background:linear-gradient(135deg,#667eea 0%,#764ba2 100%); color:#fff; border:none; border-radius:8px; font-weight:700; cursor:pointer;
        }

        /* Stats */
        .stats-bar{
            display:grid; grid-template-columns:repeat(auto-fit,minmax(180px,1fr)); gap:15px; padding:30px; background:#f8f9fa; border-bottom:2px solid #e9ecef;
        }
        .stat-card{ background:#fff; padding:20px; border-radius:12px; box-shadow:0 2px 10px rgba(0,0,0,.08); text-align:center; }
        .stat-card.video{ border-left:4px solid #667eea; }
        .stat-card.stills{ border-left:4px solid #ffc107; }
        .stat-value{ font-size:2em; font-weight:800; color:#667eea; margin-bottom:5px; }
        .stat-card.stills .stat-value{ color:#ffc107; }
        .stat-label{ color:#6c757d; font-size:.9em; text-transform:uppercase; letter-spacing:1px; }

        /* Controls */
        .controls{ padding:30px; background:#f8f9fa; display:grid; grid-template-columns:1fr 1fr; gap:20px; }
        .control-group{ display:flex; flex-direction:column; gap:6px; }
        .control-group label{ font-weight:700; color:#495057; font-size:.9em; text-transform:uppercase; letter-spacing:.5px; }
        .control-group input, .control-group select{
            padding:12px; border:2px solid #dee2e6; border-radius:8px; font-size:1em; transition:all .3s;
        }
        .control-group input:focus, .control-group select:focus{ outline:none; border-color:#667eea; box-shadow:0 0 0 3px rgba(102,126,234,.1); }

        /* ID sort button */
        .id-sort-wrap{ display:flex; gap:8px; align-items:center; }
        #idSortBtn{
            padding:10px 12px; border:none; border-radius:8px; background:#e9ecef; color:#333; font-weight:700; cursor:pointer;
        }
        #idSortBtn:hover{ background:#dee2e6; }

        .button-group{ grid-column:1 / -1; display:flex; gap:10px; margin-top:6px; flex-wrap:wrap; }
        .btn{
            padding:12px 18px; border:none; border-radius:8px; font-size:.95em; font-weight:700; cursor:pointer; transition:all .2s; flex:1; min-width:140px;
        }
        .btn-primary{ background:linear-gradient(135deg,#667eea 0%,#764ba2 100%); color:#fff; }
        .btn-primary:hover{ transform:translateY(-2px); box-shadow:0 5px 15px rgba(102,126,234,.4); }
        .btn-secondary{ background:#e9ecef; color:#495057; }
        .btn-secondary:hover{ background:#dee2e6; }
        .btn-success{ background:linear-gradient(135deg,#28a745 0%,#20c997 100%); color:#fff; }
        .btn-success:hover{ transform:translateY(-2px); box-shadow:0 5px 15px rgba(40,167,69,.4); }

        /* Sections & Tables */
        .section-divider{
            background:linear-gradient(135deg,#ffc107 0%,#ff9800 100%); color:#fff; padding:22px 30px; margin:26px 0;
            text-align:center; font-size:1.35em; font-weight:800; border-radius:8px; box-shadow:0 4px 15px rgba(255,193,7,.3);
        }
        .section-divider.video{
            background:linear-gradient(135deg,#667eea 0%,#764ba2 100%); box-shadow:0 4px 15px rgba(102,126,234,.3);
        }

        .content{ padding:30px; max-height:800px; overflow-y:auto; }
        .archive-section{ margin-bottom:46px; page-break-inside:avoid; overflow-x:auto; }
        .archive-title{
            background:linear-gradient(135deg,#667eea 0%,#764ba2 100%); color:#fff; padding:18px 24px; border-radius:8px 8px 0 0;
            font-size:1.25em; font-weight:800; display:flex; justify-content:space-between; align-items:center;
        }
        .archive-title.stills{ background:linear-gradient(135deg,#ffc107 0%,#ff9800 100%); }
        .archive-meta{ font-size:.85em; opacity:.95; }

        .archive-table{ width:100%; min-width:1200px; border-collapse:collapse; background:#fff; box-shadow:0 2px 10px rgba(0,0,0,.1); border-radius:0 0 8px 8px; overflow:hidden; }
        .archive-table thead{ background:#f8f9fa; }
        .archive-table th{
            padding:14px; text-align:left; font-weight:800; color:#495057; border-bottom:2px solid #dee2e6;
            text-transform:uppercase; font-size:.85em; letter-spacing:.5px;
        }
        .archive-table td{ padding:12px 14px; border-bottom:1px solid #e9ecef; }
        .archive-table tbody tr:hover{ background:#f8f9fa; }
        .duration-cell{ font-family:'Courier New',monospace; font-weight:800; color:#667eea; font-size:1.05em; }
        .total-row{ background:linear-gradient(135deg,#667eea 0%,#764ba2 100%)!important; color:#fff!important; font-weight:800; font-size:1.05em; }
        .total-row.stills{ background:linear-gradient(135deg,#ffc107 0%,#ff9800 100%)!important; }
        .total-row td{ border-bottom:none!important; padding:16px 14px!important; }
        .total-row .duration-cell{ color:#fff!important; font-size:1.15em; }

        .loading{ text-align:center; padding:60px; color:#6c757d; font-size:1.1em; }

        /* Header info box */
        #headerInfoDisplay{ display:none; padding:26px 40px; background:linear-gradient(135deg,#f8f9fa 0%,#e9ecef 100%); border-bottom:3px solid #667eea; }
        #headerInfoDisplay .frame{
            max-width:1200px; margin:0 auto; background:#fff; padding:26px; border-radius:12px; box-shadow:0 4px 20px rgba(0,0,0,.1); border-left:6px solid #667eea;
        }
        #headerInfoTitle{ color:#667eea; font-size:1.6em; margin:0; }
        #headerInfoContent{ display:grid; grid-template-columns:200px 1fr; gap:14px; line-height:2.1; color:#495057; font-size:1.02em; }
        .info-label{ font-weight:800; color:#667eea; }
        .info-mail{
            color:#667eea; text-decoration:none; font-weight:800; padding:8px 16px; background:rgba(102,126,234,.1);
            border-radius:6px; display:inline-block; transition:all .2s;
        }
        .info-mail:hover{ background:rgba(102,126,234,.2); }

        @media print{
            body{ background:#fff; }
            .controls,.stats-bar,.header,.sheet-config,.setup-instructions,.toggle-setup,.hamburger-menu,.sidebar{ display:none !important; }
            .container{ box-shadow:none; }
        }
    </style>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/xlsx/0.18.5/xlsx.full.min.js"
            onerror="this.onerror=null; this.src='https://unpkg.com/xlsx@0.18.5/dist/xlsx.full.min.js'"></script>
</head>
<body>
<div class="overlay" id="overlay" onclick="closeSidebar()"></div>

<!-- Sidebar -->
<div class="sidebar" id="sidebar">
    <div class="sidebar-header">
        <h2>My Sheets</h2>
        <button class="close-btn" onclick="closeSidebar()">×</button>
    </div>
    <div class="sidebar-content">
        <button class="add-sheet-btn" onclick="showAddSheetModal()">Add New Sheet</button>

        <div class="helper-box">
            <strong>Sheet Types:</strong><br>
            <strong>Public</strong> – shown from config<br>
            <strong>Modified</strong> – your edited copy<br>
            <strong>Personal</strong> – visible only for you
        </div>

        <ul class="sheet-list" id="sheetList"></ul>
        <div class="empty-state" id="emptyState" style="text-align:center; padding:30px; color:#6c757d;">
            <p>No sheets saved yet</p>
            <p style="font-size:.9em; margin-top:6px;">Click “Add New Sheet” to get started</p>
        </div>
    </div>
</div>

<!-- Modal -->
<div class="modal" id="sheetModal">
    <div class="modal-content">
        <div class="modal-header" id="modalTitle">Add New Sheet</div>
        <input type="text" class="modal-input" id="sheetEpisode" placeholder="Episode Number (e.g., 01, 02, 03...)">
        <input type="text" class="modal-input" id="sheetName" placeholder="Sheet Name (e.g., Duckwitz, Smith Archive)">
        <input type="text" class="modal-input" id="sheetUrl" placeholder="Apps Script Web App URL">
        <input type="text" class="modal-input" id="sheetLink" placeholder="Google Sheet URL (optional)">
        <div style="margin:8px 0 6px; font-weight:800; color:#667eea;">Header Information (for exports)</div>
        <input type="text" class="modal-input" id="sheetProduction" placeholder="Production Company">
        <input type="text" class="modal-input" id="sheetProject" placeholder="Film Project">
        <input type="text" class="modal-input" id="sheetResearcher" placeholder="Researcher Name">
        <input type="text" class="modal-input" id="sheetContact" placeholder="Contact Email">
        <div class="modal-buttons">
            <button class="modal-btn-save" onclick="saveSheet()">Save</button>
            <button class="modal-btn-cancel" onclick="closeModal()">Cancel</button>
        </div>
    </div>
</div>

<div class="container">
    <div class="header">
        <div class="hamburger-menu" onclick="toggleSidebar()"><div class="hamburger-icon">☰</div></div>
        <div class="live-indicator">
            <div class="live-dot" id="liveDot"></div><span id="liveStatus">Ready</span>
        </div>

        <h1>Live Archive Report</h1>
        <p>Real-time Footage Database • Film &amp; Video Archives</p>

        <!-- Active sheet name + button -->
        <div class="active-sheet-wrap">
            <div id="activeSheetName"></div>
            <button id="openSheetBtn" onclick="openSheetLink(currentSheetId)">Open Sheet</button>
        </div>
    </div>

    <div class="toggle-setup" onclick="toggleSetup()">Click here for Setup Instructions (one time)</div>

    <div class="setup-instructions" id="setupInstructions" style="display:none;">
        <h3>One-Time Setup (≈2 minutes)</h3>
        <p style="margin-bottom:14px;">Create a tiny Google Apps Script to connect your sheet.</p>

        <div class="setup-step">
            <h4>Step 1: Open Apps Script</h4>
            <p>In your Google Sheet go to: <strong>Extensions → Apps Script</strong></p>
        </div>
        <div class="setup-step">
            <h4>Step 2: Paste This Code</h4>
            <div class="code-block">function doGet(e) {
  try {
    var sheet = SpreadsheetApp.getActiveSpreadsheet().getSheetByName('DUCKWITZ EDL');
    if (!sheet) {
      return ContentService.createTextOutput(JSON.stringify({error: 'Sheet not found'}))
                           .setMimeType(ContentService.MimeType.JSON);
    }
    var data = sheet.getDataRange().getValues();
    var headers = data[0];
    var rows = [];
    for (var i = 1; i &lt; data.length; i++) {
      var row = {};
      for (var j = 0; j &lt; headers.length; j++) {
        row[headers[j]] = (data[i][j] !== null &amp;&amp; data[i][j] !== undefined) ? (''+data[i][j]) : '';
      }
      rows.push(row);
    }
    return ContentService.createTextOutput(JSON.stringify(rows))
                         .setMimeType(ContentService.MimeType.JSON);
  } catch (error) {
    return ContentService.createTextOutput(JSON.stringify({error: error.toString()}))
                         .setMimeType(ContentService.MimeType.JSON);
  }
}</div>
            <p style="margin-top:8px;"><strong>Note:</strong> Replace <code>'DUCKWITZ EDL'</code> with your sheet tab name if different.</p>
        </div>
        <div class="setup-step">
            <h4>Step 3: Deploy as Web App</h4>
            <ol style="line-height:1.9; margin-top:6px;">
                <li>Save</li><li>Deploy → New deployment</li><li>Type: Web app</li>
                <li><strong>Execute as:</strong> Me</li><li><strong>Who has access:</strong> Anyone</li>
                <li>Deploy and authorize</li><li>Copy the Web App URL (ends with /exec)</li>
            </ol>
        </div>
        <div class="setup-step">
            <h4>Step 4: Save to Sidebar</h4>
            <ol style="line-height:1.9;">
                <li>Open the ☰ menu</li><li>Click “Add New Sheet”</li><li>Paste the URL</li><li>Save</li>
            </ol>
        </div>
    </div>

    <div class="sheet-config">
        <div style="margin-bottom:18px; padding:18px; background:linear-gradient(135deg,#d4edda 0%,#c3e6cb 100%); border-radius:8px; border:3px solid #28a745;">
            <h3 style="color:#155724; margin-bottom:10px;">Connect to Google Sheets</h3>
            <div class="sheet-input-group">
                <input type="text" id="appsScriptUrl" placeholder="Paste your Apps Script Web App URL here...">
                <button onclick="testConnection()" style="background:linear-gradient(135deg,#ffc107 0%,#ff9800 100%);">Test</button>
                <button onclick="connectToSheet()" style="background:linear-gradient(135deg,#28a745 0%,#20c997 100%);">Connect</button>
            </div>
            <div class="sheet-input-group" style="margin-top:10px;">
                <button class="btn btn-primary" onclick="refreshData()" style="flex:1;">Refresh</button>
                <button class="btn btn-primary" onclick="startAutoRefresh()" style="flex:1;">Auto (30s)</button>
                <button class="btn btn-secondary" onclick="stopAutoRefresh()" style="flex:1;">Stop</button>
            </div>
        </div>
        <div class="help-text" style="font-size:.9em; color:#6c757d;">
            Tip: Save your sheets in the sidebar (☰) for quick access.<br/>
            Last update: <span id="lastUpdate">Never</span> | Auto-refresh: <span id="autoRefreshStatus">Off</span>
        </div>
    </div>

    <!-- Header information panel -->
    <div id="headerInfoDisplay">
        <div class="frame">
            <div style="display:flex; align-items:center; margin-bottom:14px; padding-bottom:12px; border-bottom:2px solid #e9ecef;">
                <h2 id="headerInfoTitle">Sheet Information</h2>
            </div>
            <div id="headerInfoContent"></div>
        </div>
    </div>

    <!-- Stats -->
    <div class="stats-bar">
        <div class="stat-card video">
            <div class="stat-value" id="videoClips">0</div>
            <div class="stat-label">Video Clips</div>
        </div>
        <div class="stat-card video">
            <div class="stat-value" id="videoArchives">0</div>
            <div class="stat-label">Video Archives</div>
        </div>
        <div class="stat-card video">
            <div class="stat-value" id="videoDuration">00:00:00:00</div>
            <div class="stat-label">Video Duration</div>
        </div>
        <div class="stat-card stills">
            <div class="stat-value" id="stillsCount">0</div>
            <div class="stat-label">Stills/Images</div>
        </div>
        <div class="stat-card stills">
            <div class="stat-value" id="stillsArchives">0</div>
            <div class="stat-label">Stills Archives</div>
        </div>
        <div class="stat-card video">
            <div class="stat-value" id="uniqueSources">0</div>
            <div class="stat-label">Unique Sources</div>
        </div>
    </div>

    <!-- Controls -->
    <div class="controls">
        <div class="control-group">
            <label for="searchInput">Search</label>
            <input type="text" id="searchInput" placeholder="Search by Archive, ID, Inv No, or File Name...">
        </div>
        <div class="control-group">
            <label for="sortSelect">Sort By</label>
            <select id="sortSelect">
                <option value="duration-desc">Duration (Longest First)</option>
                <option value="duration-asc">Duration (Shortest First)</option>
                <option value="name-asc">Archive Name (A–Z)</option>
                <option value="name-desc">Archive Name (Z–A)</option>
                <option value="clips-desc">Clip Count (Most First)</option>
                <option value="clips-asc">Clip Count (Least First)</option>
            </select>
            <!-- NEW: ID sort button -->
            <div class="id-sort-wrap" style="margin-top:6px;">
                <button id="idSortBtn" onclick="toggleIdSort()">ID: Off</button>
            </div>
        </div>
        <div class="control-group">
            <label for="filterArchive">Filter by Archive</label>
            <select id="filterArchive"><option value="all">All Archives</option></select>
        </div>
        <div class="control-group">
            <label for="viewMode">View Mode</label>
            <select id="viewMode">
                <option value="all">Show All (Video + Stills)</option>
                <option value="video">Video Clips Only</option>
                <option value="stills">Stills/Images Only</option>
            </select>
        </div>
        <div class="button-group">
            <button class="btn btn-primary" onclick="applyFilters()">Apply Filters</button>
            <button class="btn btn-secondary" onclick="resetFilters()">Reset All</button>
            <button class="btn btn-success" onclick="copyPlainText()">Copy as Table</button>
            <button class="btn btn-success" onclick="copyAsTable()">Copy with Summary</button>
            <button class="btn btn-success" onclick="exportToExcel()">Export to Excel</button>
            <button class="btn btn-secondary" onclick="window.print()">Print</button>
        </div>
    </div>

    <!-- Content -->
    <div class="content" id="content">
        <div class="loading">
            <h3>Welcome to Live Archive Report</h3>
            <p style="margin:16px 0;">Use the ☰ menu to add your sheets, or paste a URL above to get started.</p>
        </div>
    </div>
</div>

<script>
let archiveData = [];
let filteredData = [];
let autoRefreshInterval = null;
let connectedUrl = '';
let savedSheets = [];
let currentSheetId = null;
let editingSheetId = null;
let currentSheetName = '';
let currentSheetInfo = {};
let idSortMode = 'none'; // 'none' | 'asc' | 'desc'  ← NEW

function updateIdSortBtn(){
    const btn = document.getElementById('idSortBtn');
    if (!btn) return;
    if (idSortMode==='asc') { btn.textContent = 'ID: ↑'; }
    else if (idSortMode==='desc') { btn.textContent = 'ID: ↓'; }
    else { btn.textContent = 'ID: Off'; }
}
function toggleIdSort(){
    idSortMode = (idSortMode==='none') ? 'asc' : (idSortMode==='asc' ? 'desc' : 'none');
    updateIdSortBtn();
    applyFilters();
}

async function loadSavedSheets() {
    savedSheets = [];
    try {
        let configUrl = 'https://raw.githubusercontent.com/pvpeneva/live-archive-tool/main/sheets-config.json';
        let response = await fetch(configUrl + '?t=' + Date.now());
        if (response.status === 404) {
            configUrl = 'https://raw.githubusercontent.com/pvpeneva/live-archive-tool/master/sheets-config.json';
            response = await fetch(configUrl + '?t=' + Date.now());
        }
        if (response.ok) {
            const config = await response.json();
            if (config.sheets && Array.isArray(config.sheets)) {
                config.sheets.forEach(sheet => {
                    savedSheets.push({ ...sheet, fromConfig:true, addedAt:sheet.addedAt || new Date().toISOString() });
                });
            }
        }
    } catch(e){ console.error('Config load error:', e); }

    try {
        const savedLocal = localStorage.getItem('savedSheets');
        if (savedLocal) {
            const localSheets = JSON.parse(savedLocal);
            const configLoaded = savedSheets.length > 0;
            localSheets.forEach(localSheet => {
                const exists = savedSheets.find(s => s.id === localSheet.id);
                if (!exists) {
                    if (!configLoaded || !localSheet.fromConfig) savedSheets.push(localSheet);
                }
            });
        }
    } catch(e){ console.error('localStorage load error:', e); }

    // Shared-in link (?s=...)
    const urlParams = new URLSearchParams(window.location.search);
    const shareParam = urlParams.get('s');
    if (shareParam) {
        try {
            const decoded = JSON.parse(decodeURIComponent(escape(atob(shareParam))));
            const sharedData = {
                id: decoded.i, episode: decoded.e || '', name: decoded.n, url: decoded.u, sheetLink: decoded.l || '',
                production: decoded.p || '', project: decoded.j || '', researcher: decoded.r || '', contact: decoded.c || ''
            };
            if (!savedSheets.find(s => s.id === sharedData.id)) {
                savedSheets.push({ ...sharedData, addedAt:new Date().toISOString() });
                localStorage.setItem('savedSheets', JSON.stringify(savedSheets));
                const cleanUrl = window.location.origin + window.location.pathname;
                history.replaceState(null,null,cleanUrl);
                alert('Sheet imported successfully.\n\n' + (sharedData.episode ? sharedData.episode + '_' : '') + sharedData.name);
            }
            renderSheetList();
            setTimeout(()=>loadSheet(sharedData.id), 400);
            return;
        } catch(e){ console.error('Share decode error:', e); }
    }

    renderSheetList();
    if (savedSheets.length > 0) {
        const lastActive = localStorage.getItem('lastActiveSheet');
        if (lastActive && savedSheets.find(s => s.id === lastActive)) loadSheet(lastActive);
        else loadSheet(savedSheets[0].id);
    }
    updateIdSortBtn(); // init label
}

function renderSheetList(){
    const list = document.getElementById('sheetList');
    const emptyState = document.getElementById('emptyState');
    if (savedSheets.length === 0){ list.style.display='none'; emptyState.style.display='block'; return; }
    list.style.display='block'; emptyState.style.display='none';

    const sorted = [...savedSheets].sort((a,b)=>(a.episode||'999').localeCompare(b.episode||'999'));
    list.innerHTML = sorted.map(sheet=>{
        const display = sheet.episode ? `${sheet.episode}_${sheet.name}` : sheet.name;
        const isActive = sheet.id === currentSheetId;
        const isConfig = sheet.fromConfig && !sheet.modified;
        const isModified = sheet.fromConfig && sheet.modified;
        const bg = isConfig ? 'border-left-color:#28a745;background:linear-gradient(135deg,rgba(40,167,69,.05),rgba(32,201,151,.05));'
                  : isModified ? 'border-left-color:#ffc107;background:linear-gradient(135deg,rgba(255,193,7,.05),rgba(255,152,0,.05));' : '';
        return `
        <li class="sheet-item ${isActive ? 'active':''}" onclick="loadSheet('${sheet.id}')" style="${bg}">
            <div class="sheet-item-name">${display}</div>
            <div class="sheet-item-url">${(sheet.url||'').substring(0,40)}...</div>
            <div class="sheet-item-actions" onclick="event.stopPropagation()">
                ${sheet.sheetLink ? `<button class="action-btn" onclick="openSheetLink('${sheet.id}')" title="Open Google Sheet">Open</button>` : ''}
                <button class="action-btn" onclick="editSheet('${sheet.id}')" title="Edit">Edit</button>
                <button class="action-btn" onclick="shareSheet('${sheet.id}')" title="Copy Share Link">Share</button>
                ${isConfig ? '' : `<button class="action-btn delete" onclick="deleteSheet('${sheet.id}')" title="Delete">Del</button>`}
            </div>
        </li>`;
    }).join('');
}

function shareSheet(id){
    const sheet = savedSheets.find(s=>s.id===id); if(!sheet) return;
    const payload = { i:sheet.id, e:sheet.episode||'', n:sheet.name, u:sheet.url, l:sheet.sheetLink||'',
                      p:sheet.production||'', j:sheet.project||'', r:sheet.researcher||'', c:sheet.contact||'' };
    try{
        const encoded = btoa(unescape(encodeURIComponent(JSON.stringify(payload))));
        const link = (window.location.origin + window.location.pathname) + '?s=' + encoded;
        if (navigator.clipboard?.writeText) {
            navigator.clipboard.writeText(link).then(()=> alert('Share link copied to clipboard.'));
        } else { prompt('Copy this link:', link); }
    }catch(e){ alert('Error creating share link: ' + e.message); }
}

function toggleSidebar(){ document.getElementById('sidebar').classList.toggle('open'); document.getElementById('overlay').classList.toggle('show'); }
function closeSidebar(){ document.getElementById('sidebar').classList.remove('open'); document.getElementById('overlay').classList.remove('show'); }

function showAddSheetModal(){
    editingSheetId=null;
    document.getElementById('modalTitle').textContent='Add New Sheet';
    ['sheetEpisode','sheetName','sheetUrl','sheetLink','sheetProduction','sheetProject','sheetResearcher','sheetContact']
      .forEach(id=>document.getElementById(id).value='');
    document.getElementById('sheetModal').classList.add('show');
}

function openSheetLink(id){
    const sheet = savedSheets.find(s=>s.id===id); if(!sheet) return;
    if (sheet.sheetLink) window.open(sheet.sheetLink,'_blank'); else alert('No Google Sheet link is set for this item.');
}

function editSheet(id){
    const sheet = savedSheets.find(s=>s.id===id); if(!sheet) return;
    editingSheetId=id;
    document.getElementById('modalTitle').textContent = sheet.fromConfig && !sheet.modified ? 'Edit Sheet (Local Copy)' : 'Edit Sheet';
    document.getElementById('sheetEpisode').value = sheet.episode || '';
    document.getElementById('sheetName').value = sheet.name || '';
    document.getElementById('sheetUrl').value = sheet.url || '';
    document.getElementById('sheetLink').value = sheet.sheetLink || '';
    document.getElementById('sheetProduction').value = sheet.production || '';
    document.getElementById('sheetProject').value = sheet.project || '';
    document.getElementById('sheetResearcher').value = sheet.researcher || '';
    document.getElementById('sheetContact').value = sheet.contact || '';
    document.getElementById('sheetModal').classList.add('show');
}

function closeModal(){ document.getElementById('sheetModal').classList.remove('show'); editingSheetId=null; }

function saveSheet(){
    const episode = document.getElementById('sheetEpisode').value.trim();
    const name = document.getElementById('sheetName').value.trim();
    const url = document.getElementById('sheetUrl').value.trim();
    const sheetLink = document.getElementById('sheetLink').value.trim();
    const production = document.getElementById('sheetProduction').value.trim();
    const project = document.getElementById('sheetProject').value.trim();
    const researcher = document.getElementById('sheetResearcher').value.trim();
    const contact = document.getElementById('sheetContact').value.trim();

    if (!name) return alert('Please enter a name for this sheet.');
    if (!url || !url.includes('script.google.com') || !url.includes('/exec')) return alert('Please enter a valid Apps Script Web App URL (must end with /exec).');

    if (editingSheetId){
        const idx = savedSheets.findIndex(s=>s.id===editingSheetId);
        if (idx>=0){
            const wasFromConfig = savedSheets[idx].fromConfig && !savedSheets[idx].modified;
            savedSheets[idx] = { ...savedSheets[idx],
                episode,name,url,sheetLink,production,project,researcher,contact,
                modified: wasFromConfig ? true : savedSheets[idx].modified
            };
        }
    } else {
        savedSheets.push({
            id:'sheet_'+Date.now(), episode,name,url,sheetLink,production,project,researcher,contact,
            addedAt:new Date().toISOString(), fromConfig:false
        });
    }
    localStorage.setItem('savedSheets', JSON.stringify(savedSheets));
    renderSheetList(); closeModal();

    // Load selection
    setTimeout(()=> {
        const id = editingSheetId ? editingSheetId : savedSheets[savedSheets.length-1].id;
        loadSheet(id);
    }, 300);
}

function deleteSheet(id){
    const sheet = savedSheets.find(s=>s.id===id); if(!sheet) return;
    if (sheet.fromConfig && !sheet.modified) return alert('Cannot delete original config sheets.');
    if (!confirm('Delete this sheet?')) return;
    savedSheets = savedSheets.filter(s=>s.id!==id);
    localStorage.setItem('savedSheets', JSON.stringify(savedSheets));
    if (currentSheetId===id){ currentSheetId=null; connectedUrl=''; }
    renderSheetList();
}

function loadSheet(id){
    const sheet = savedSheets.find(s=>s.id===id); if(!sheet) return;
    currentSheetId = id; connectedUrl = sheet.url;
    currentSheetName = sheet.episode ? `${sheet.episode}_${sheet.name}` : sheet.name;
    currentSheetInfo = {
        production:sheet.production||'', project:sheet.project||'', episode:sheet.episode||'', name:sheet.name||'',
        researcher:sheet.researcher||'', contact:sheet.contact||'', sheetLink:sheet.sheetLink||''
    };
    localStorage.setItem('lastActiveSheet', id);

    // Header name & button
    document.getElementById('activeSheetName').textContent = currentSheetName ? `Active: ${currentSheetName}` : '';
    const btn = document.getElementById('openSheetBtn');
    if (currentSheetInfo.sheetLink){ btn.style.display='inline-block'; } else { btn.style.display='none'; }

    // Fill URL field & render
    document.getElementById('appsScriptUrl').value = sheet.url;
    renderSheetList(); closeSidebar();
    updateHeaderInfoDisplay();
    refreshData();
}

function updateHeaderInfoDisplay(){
    const display = document.getElementById('headerInfoDisplay');
    const content = document.getElementById('headerInfoContent');
    if (currentSheetInfo.production || currentSheetInfo.project || currentSheetInfo.researcher || currentSheetInfo.contact || currentSheetInfo.episode || currentSheetInfo.name){
        let html = '';
        if (currentSheetInfo.production){ html += `<div class="info-label">Production company:</div><div>${currentSheetInfo.production}</div>`; }
        if (currentSheetInfo.project){ html += `<div class="info-label">Film project:</div><div>${currentSheetInfo.project}</div>`; }
        if (currentSheetInfo.episode || currentSheetInfo.name){
            const ep = currentSheetInfo.episode ? `${currentSheetInfo.episode} ${currentSheetInfo.name}` : currentSheetInfo.name;
            html += `<div class="info-label">Episode:</div><div style="font-weight:800; font-size:1.05em;">${ep}</div>`;
        }
        if (currentSheetInfo.researcher){ html += `<div class="info-label">Researcher:</div><div>${currentSheetInfo.researcher}</div>`; }
        if (currentSheetInfo.contact){
            html += `<div class="info-label">Contact:</div><div><a class="info-mail" href="mailto:${currentSheetInfo.contact}">${currentSheetInfo.contact}</a></div>`;
        }
        if (currentSheetInfo.sheetLink){
            html += `<div class="info-label">Google Sheet:</div><div><a href="${currentSheetInfo.sheetLink}" target="_blank" class="info-mail" style="background:rgba(40,167,69,.12);">Open Sheet</a></div>`;
        }
        content.innerHTML = html; display.style.display='block';
    } else { display.style.display='none'; }
}

function testConnection(){
    const url = document.getElementById('appsScriptUrl').value.trim();
    if (!url) return alert('Please paste your Apps Script Web App URL first.');
    if (!url.includes('script.google.com')) return alert('Invalid URL.');
    if (!url.includes('/exec')) alert('Note: URL should end with /exec');
    window.open(url,'_blank');
}

function toggleSetup(){ const s = document.getElementById('setupInstructions'); s.style.display = (s.style.display==='none'?'block':'none'); }

function connectToSheet(){
    const url = document.getElementById('appsScriptUrl').value.trim();
    if (!url) return alert('Please paste your Apps Script Web App URL.');
    if (!url.includes('script.google.com') || !url.includes('/exec')) return alert('Invalid URL.');
    connectedUrl = url; refreshData();
}

async function refreshData(){
    if (!connectedUrl){ alert('Please connect to your sheet first.'); return; }
    updateLiveStatus('loading','Loading...');
    document.getElementById('content').innerHTML = '<div class="loading">Fetching data…</div>';
    try{
        const url = connectedUrl + (connectedUrl.includes('?') ? '&' : '?') + '_=' + Date.now();
        const resp = await fetch(url,{method:'GET', headers:{Accept:'application/json'}});
        if (!resp.ok) throw new Error('HTTP ' + resp.status);
        const data = await resp.json();
        if (data.error) throw new Error(data.error);
        if (!Array.isArray(data) || data.length===0) throw new Error('No data returned');
        processData(data);
        updateLiveStatus('success','Connected');
        document.getElementById('lastUpdate').textContent = new Date().toLocaleTimeString();
    }catch(err){
        updateLiveStatus('error','Failed');
        document.getElementById('content').innerHTML =
            `<div style="background:#fee;border:2px solid #fcc;color:#c33;padding:28px;border-radius:12px;margin:40px;text-align:center;">
                <h3>Connection Error</h3>
                <p style="margin:16px 0;"><strong>Error:</strong> ${err.message}</p>
                <button onclick="window.open('${connectedUrl}','_blank')" style="margin-top:10px;padding:10px 18px;background:#667eea;color:#fff;border:none;border-radius:8px;cursor:pointer;">Open URL</button>
            </div>`;
    }
}

function detectDurationColumn(row){
    if (!row) return null;
    const names = ['SOURCE_DURATION','SOURCE DURATION','Source Duration','DURATION','Duration','duration',
                   'CLIP_DURATION','Clip Duration','clip_duration','LENGTH','Length','length','RUNTIME','Runtime','runtime',
                   'TC_DURATION','TC Duration','tc_duration'];
    for (const n of names){ if (row.hasOwnProperty(n)) return n; }
    for (const k in row){ if (k.toLowerCase().includes('duration')) return k; }
    return null;
}

function TCSUM(arr,fpsValue){
    let fps = 30;
    if (fpsValue!==undefined && fpsValue!==''){
        const s = fpsValue.toString().replace(',', '.').replace(';','.');
        const m = s.match(/\d+[.,]?\d*/); if (m){ const v = parseFloat(m[0]); if(!isNaN(v)) fps=v; }
    }
    let total = 0;
    for (const tc of arr){
        if (!tc) continue; const txt = tc.toString().trim(); if (txt==='') continue;
        let sign = 1; if (/^-|\(/.test(txt)) sign = -1;
        const clean = txt.replace(/[^0-9:]/g,''); if (clean==='') continue;
        const p = clean.split(':'); const h=+p[0]||0, m=+p[1]||0, s=+p[2]||0, f=+p[3]||0;
        total += sign*(h*3600*fps + m*60*fps + s*fps + f);
    }
    total = Math.round(total); let neg=''; if (total<0){ neg='-'; total=Math.abs(total); }
    const h=Math.floor(total/(3600*fps)); const remH=total%(3600*fps);
    const m=Math.floor(remH/(60*fps)); const remM=remH%(60*fps);
    const s=Math.floor(remM/fps); const f=remM%fps;
    const pad=n=>n<10?'0'+n:''+n;
    return `${neg}${pad(h)}:${pad(m)}:${pad(s)}:${pad(f)}`;
}

function processData(rows){
    const map = new Map();
    const durationCol = detectDurationColumn(rows[0]);

    rows.forEach(row=>{
        const archive = (row.Archive || row.archive || row.ARCHIVE || '').toString().trim();
        if (!archive) return;
        const id = (row.ID || row.id || '').toString().trim();
        const invNo = (row.inv_no || row['inv no'] || row['Inv No'] || '').toString().trim();
        const fileName = (row.FILE_NAME || row['FILE NAME'] || row['File Name'] || '').toString().trim();
        let duration = '00:00:00:00';
        if (durationCol && row[durationCol]) duration = row[durationCol].toString().trim();
        else duration = (row.SOURCE_DURATION || row['SOURCE DURATION'] || row['Source Duration'] || row.Duration || row.duration || '00:00:00:00').toString().trim();

        const sourceIn = (row.SOURCE_IN || row['SOURCE IN'] || row['Source In'] || '').toString().trim();
        const sourceOut = (row.SOURCE_OUT || row['SOURCE OUT'] || row['Source Out'] || '').toString().trim();
        const link = (row.link || row.Link || row.URL || '').toString().trim();

        if (!map.has(archive)) map.set(archive,{ name:archive, clips:[], allDurations:[] });
        map.get(archive).clips.push({ id,invNo,fileName,duration,sourceIn,sourceOut,link });
        map.get(archive).allDurations.push(duration);
    });

    archiveData = Array.from(map.values()).map(a=>{
        const totalDuration = TCSUM(a.allDurations,30);
        const totalFrames = timecodeToFrames(totalDuration,30);
        return { name:a.name, entries:a.clips.length, clips:a.clips, totalFrames, duration:totalDuration,
                 type: totalDuration==='00:00:00:00' ? 'stills' : 'video', fps:30 };
    });

    populateArchiveFilter();
    resetFilters();
}

function timecodeToFrames(tc,fps){ if(!tc || tc==='00:00:00:00') return 0; const p=tc.split(':').map(x=>parseInt(x)||0); const [h,m,s,f]=p; return h*3600*fps+m*60*fps+s*fps+f; }
function framesToTimecode(frames,fps){ if(frames===0) return '00:00:00:00'; const h=Math.floor(frames/(3600*fps)); const m=Math.floor((frames%(3600*fps))/(60*fps)); const s=Math.floor((frames%(60*fps))/fps); const f=frames%fps; return `${String(h).padStart(2,'0')}:${String(m).padStart(2,'0')}:${String(s).padStart(2,'0')}:${String(f).padStart(2,'0')}`; }
function updateLiveStatus(status,text){ const d=document.getElementById('liveDot'); const t=document.getElementById('liveStatus'); d.className='live-dot'; if(status==='error') d.classList.add('error'); t.textContent=text; }

function startAutoRefresh(){ if(autoRefreshInterval) return; if(!connectedUrl){ alert('Connect to a sheet first.'); return; } autoRefreshInterval=setInterval(()=>refreshData(),30000); document.getElementById('autoRefreshStatus').textContent='On (30s)'; }
function stopAutoRefresh(){ if(autoRefreshInterval){ clearInterval(autoRefreshInterval); autoRefreshInterval=null; } document.getElementById('autoRefreshStatus').textContent='Off'; }

function populateArchiveFilter(){
    const select=document.getElementById('filterArchive'); select.innerHTML='<option value="all">All Archives</option>';
    [...new Set(archiveData.map(a=>a.name))].sort().forEach(a=>{ const o=document.createElement('option'); o.value=a; o.textContent=a; select.appendChild(o); });
}

function renderTables(data){
    const content=document.getElementById('content');
    if (data.length===0){ content.innerHTML='<div class="loading">No archives match your filters</div>'; return; }
    const video = data.filter(a=>a.type==='video'); const stills = data.filter(a=>a.type==='stills');
    let html='';

    if (video.length>0){
        html += '<div class="section-divider video">VIDEO CLIPS</div>';
        html += video.map(archive=>`
          <div class="archive-section">
            <div class="archive-title"><span>${archive.name}</span><span class="archive-meta">${archive.clips.length} clips</span></div>
            <table class="archive-table">
              <thead><tr>
                <th style="width:50px">#</th><th style="width:100px">ID</th><th style="width:100px">Inv No</th>
                <th style="width:200px">File Name</th><th style="width:120px">Source In</th><th style="width:120px">Source Out</th>
                <th style="width:120px">Duration</th><th style="width:110px">Link</th>
              </tr></thead>
              <tbody>
                ${archive.clips.map((c,i)=>`
                  <tr>
                    <td>${i+1}</td><td>${c.id||'—'}</td><td>${c.invNo||'—'}</td>
                    <td style="font-size:.9em;">${c.fileName||'—'}</td>
                    <td class="duration-cell" style="font-size:.9em;">${c.sourceIn||'—'}</td>
                    <td class="duration-cell" style="font-size:.9em;">${c.sourceOut||'—'}</td>
                    <td class="duration-cell">${c.duration}</td>
                    <td>${c.link ? `<a href="${c.link}" target="_blank" style="color:#667eea;">Link</a>` : '—'}</td>
                  </tr>`).join('')}
                <tr class="total-row"><td colspan="6"><strong>TOTAL</strong></td><td class="duration-cell">${archive.duration}</td><td></td></tr>
              </tbody>
            </table>
          </div>
        `).join('');
    }

    if (stills.length>0){
        html += '<div class="section-divider">STILLS / IMAGES</div>';
        html += stills.map(archive=>`
          <div class="archive-section">
            <div class="archive-title stills"><span>${archive.name}</span><span class="archive-meta">${archive.entries} stills</span></div>
            <table class="archive-table">
              <thead><tr>
                <th style="width:50px">#</th><th style="width:100px">ID</th><th style="width:100px">Inv No</th>
                <th style="width:250px">File Name</th><th style="width:150px">Type</th><th style="width:110px">Link</th>
              </tr></thead>
              <tbody>
                ${archive.clips.map((c,i)=>`
                  <tr>
                    <td>${i+1}</td><td>${c.id||'—'}</td><td>${c.invNo||'—'}</td>
                    <td style="font-size:.9em;">${c.fileName||'—'}</td>
                    <td>Still Image</td>
                    <td>${c.link ? `<a href="${c.link}" target="_blank" style="color:#667eea;">Link</a>` : '—'}</td>
                  </tr>`).join('')}
                <tr class="total-row stills"><td colspan="6"><strong>TOTAL: ${archive.entries} Still Images</strong></td></tr>
              </tbody>
            </table>
          </div>
        `).join('');
    }

    content.innerHTML = html;
    updateStats(data);
}

function parseIdNumber(id){
    if (!id) return NaN;
    const m = id.toString().match(/\d+/); // първата числова поредица
    return m ? parseInt(m[0],10) : NaN;
}

function applyFilters(){
    const term = document.getElementById('searchInput').value.toLowerCase();
    const sortBy = document.getElementById('sortSelect').value;
    const filterArchive = document.getElementById('filterArchive').value;
    const viewMode = document.getElementById('viewMode').value;

    filteredData = archiveData.filter(a=>{
        const matchesSearch = a.name.toLowerCase().includes(term) ||
            a.clips.some(c => (c.id||'').toLowerCase().includes(term) ||
                               (c.invNo||'').toLowerCase().includes(term) ||
                               (c.fileName||'').toLowerCase().includes(term));
        const matchesArchive = (filterArchive==='all' || a.name===filterArchive);
        let matchesView = true;
        if (viewMode==='video') matchesView = a.type==='video';
        else if (viewMode==='stills') matchesView = a.type==='stills';
        return matchesSearch && matchesArchive && matchesView;
    });

    filteredData.sort((a,b)=>{
        switch (sortBy){
            case 'duration-desc': return b.totalFrames - a.totalFrames;
            case 'duration-asc': return a.totalFrames - b.totalFrames;
            case 'name-asc': return a.name.localeCompare(b.name);
            case 'name-desc': return b.name.localeCompare(a.name);
            case 'clips-desc': return b.entries - a.entries;
            case 'clips-asc': return a.entries - b.entries;
            default: return 0;
        }
    });

    // NEW: вътрешно сортиране на клиповете по ID за всеки архив
    let dataForRender = filteredData.map(a=>{
        if (idSortMode==='none') return a;
        const sortedClips = [...a.clips].sort((x,y)=>{
            const nx = parseIdNumber(x.id);
            const ny = parseIdNumber(y.id);
            // ако няма числа, fallback към лексикографски
            if (isNaN(nx) || isNaN(ny)) return idSortMode==='asc'
                ? ( (x.id||'').localeCompare(y.id||'') )
                : ( (y.id||'').localeCompare(x.id||'') );
            return idSortMode==='asc' ? (nx - ny) : (ny - nx);
        });
        return { ...a, clips: sortedClips };
    });

    renderTables(dataForRender);
}

function resetFilters(){
    document.getElementById('searchInput').value='';
    document.getElementById('sortSelect').value='duration-desc';
    document.getElementById('filterArchive').value='all';
    document.getElementById('viewMode').value='all';
    idSortMode='none'; updateIdSortBtn(); // reset ID sort
    applyFilters();
}

function updateStats(data){
    const video = data.filter(a=>a.type==='video');
    const stills = data.filter(a=>a.type==='stills');
    const videoClips = video.reduce((s,a)=>s+a.clips.length,0);
    const stillsCount = stills.reduce((s,a)=>s+a.entries,0);
    const allDurations = video.flatMap(a=>a.clips.map(c=>c.duration));
    const total = TCSUM(allDurations,30);

    const toBaseName = name => !name ? '' : name.toString().trim().toLowerCase().replace(/\.[a-z0-9]+$/i,'');
    const unique = new Set(video.flatMap(a=>a.clips.map(c=>c.fileName)).filter(Boolean).map(toBaseName));

    document.getElementById('videoClips').textContent = videoClips;
    document.getElementById('videoArchives').textContent = video.length;
    document.getElementById('videoDuration').textContent = total;
    document.getElementById('stillsCount').textContent = stillsCount;
    document.getElementById('stillsArchives').textContent = stills.length;
    const el = document.getElementById('uniqueSources'); if (el) el.textContent = unique.size;
}

/* Copy plain table (no emojis) */
function copyPlainText(){
    const data = (filteredData && filteredData.length>0) ? filteredData : archiveData;
    if (!data || data.length===0) return alert('No data to copy. Load a sheet first.');
    const video = data.filter(a=>a.type==='video'); const stills = data.filter(a=>a.type==='stills');

    let html = '<html><head><style>';
    html += 'body{font-family:Arial,sans-serif;font-size:11pt;}';
    html += 'table{border-collapse:collapse;width:100%;margin-bottom:20px;border:1px solid #000;}';
    html += 'th{background:#fff;color:#000;padding:8px;text-align:left;font-weight:bold;border:1px solid #000;}';
    html += 'td{padding:8px;border:1px solid #000;background:#fff;color:#000;}';
    html += '.section-title{font-weight:bold;font-size:12pt;margin:15px 0 8px 0;color:#000;}';
    html += '.archive-name{font-weight:bold;margin:12px 0 6px 0;font-size:11pt;color:#000;}';
    html += '.total-row{background:#fff;font-weight:bold;border-top:2px solid #000;}';
    html += 'a{color:#0066cc;text-decoration:none;}';
    html += '</style></head><body>';

    if (video.length>0){
        html += '<div class="section-title">VIDEO ARCHIVES</div>';
        video.forEach(a=>{
            html += `<div class="archive-name">${a.name} (${a.clips.length} clips)</div>`;
            html += '<table><thead><tr><th>#</th><th>ID</th><th>Inv No</th><th>File Name</th><th>Source In</th><th>Source Out</th><th>Duration</th><th>Link</th></tr></thead><tbody>';
            a.clips.forEach((c,i)=>{
                html += `<tr><td>${i+1}</td><td>${c.id||''}</td><td>${c.invNo||''}</td><td>${c.fileName||''}</td><td>${c.sourceIn||''}</td><td>${c.sourceOut||''}</td><td>${c.duration||'00:00:00:00'}</td><td>${c.link?`<a href="${c.link}">Link</a>`:''}</td></tr>`;
            });
            html += `<tr class="total-row"><td colspan="6"><strong>TOTAL</strong></td><td><strong>${a.duration}</strong></td><td></td></tr>`;
            html += '</tbody></table>';
        });
    }
    if (stills.length>0){
        html += '<div class="section-title">STILLS / IMAGES</div>';
        stills.forEach(a=>{
            html += `<div class="archive-name">${a.name} (${a.entries} stills)</div>`;
            html += '<table><thead><tr><th>#</th><th>ID</th><th>Inv No</th><th>File Name</th><th>Type</th><th>Link</th></tr></thead><tbody>';
            a.clips.forEach((c,i)=>{
                html += `<tr><td>${i+1}</td><td>${c.id||''}</td><td>${c.invNo||''}</td><td>${c.fileName||''}</td><td>Still Image</td><td>${c.link?`<a href="${c.link}">Link</a>`:''}</td></tr>`;
            });
            html += `<tr class="total-row"><td colspan="6"><strong>TOTAL: ${a.entries} Still Images</strong></td></tr>`;
            html += '</tbody></table>';
        });
    }
    html += '</body></html>';
    copyFormattedContent(html);
}

/* Copy with summary (no emojis) */
function copyAsTable(){
    const data = (filteredData && filteredData.length>0) ? filteredData : archiveData;
    if (!data || data.length===0) return alert('No data to copy. Load a sheet first.');
    const video = data.filter(a=>a.type==='video'); const stills = data.filter(a=>a.type==='stills');

    let html = '<html><head><style>';
    html += 'body{font-family:Arial,sans-serif;font-size:11pt;}';
    html += 'table{border-collapse:collapse;width:100%;margin-bottom:20px;border:1px solid #000;}';
    html += 'th{background:#fff;color:#000;padding:8px;text-align:left;font-weight:bold;border:1px solid #000;}';
    html += 'td{padding:8px;border:1px solid #000;background:#fff;color:#000;}';
    html += '.main-title{font-size:14pt;font-weight:bold;color:#000;margin-bottom:14px;text-align:center;}';
    html += '.section-title{font-weight:bold;font-size:12pt;margin:15px 0 8px 0;color:#000;}';
    html += '.archive-name{font-weight:bold;margin:12px 0 6px 0;font-size:11pt;color:#000;}';
    html += '.total-row{background:#fff;font-weight:bold;border-top:2px solid #000;}';
    html += '.info-table{border:1px solid #000;margin-bottom:16px;}';
    html += '.info-label{font-weight:bold;width:180px;background:#fff;border:1px solid #000;padding:6px;}';
    html += '.info-value{background:#fff;border:1px solid #000;padding:6px;}';
    html += 'a{color:#0066cc;text-decoration:none;}';
    html += '</style></head><body>';

    if (currentSheetName) html += `<div class="main-title">${currentSheetName}</div>`;

    if (currentSheetInfo.production || currentSheetInfo.project || currentSheetInfo.researcher || currentSheetInfo.contact || currentSheetInfo.episode || currentSheetInfo.name){
        html += '<table class="info-table"><thead><tr><th colspan="2">Sheet Information</th></tr></thead><tbody>';
        if (currentSheetInfo.production) html += `<tr><td class="info-label">Production company:</td><td class="info-value">${currentSheetInfo.production}</td></tr>`;
        if (currentSheetInfo.project) html += `<tr><td class="info-label">Film project:</td><td class="info-value">${currentSheetInfo.project}</td></tr>`;
        if (currentSheetInfo.episode || currentSheetInfo.name){
            const ep = currentSheetInfo.episode ? `${currentSheetInfo.episode} ${currentSheetInfo.name}` : currentSheetInfo.name;
            html += `<tr><td class="info-label">Episode:</td><td class="info-value">${ep}</td></tr>`;
        }
        if (currentSheetInfo.researcher) html += `<tr><td class="info-label">Researcher:</td><td class="info-value">${currentSheetInfo.researcher}</td></tr>`;
        if (currentSheetInfo.contact) html += `<tr><td class="info-label">Contact:</td><td class="info-value">${currentSheetInfo.contact}</td></tr>`;
        if (currentSheetInfo.sheetLink) html += `<tr><td class="info-label">Google Sheet:</td><td class="info-value"><a href="${currentSheetInfo.sheetLink}">Open Sheet</a></td></tr>`;
        html += '</tbody></table>';
    }

    if (video.length>0){
        html += '<div class="section-title">VIDEO ARCHIVES</div>';
        video.forEach(a=>{
            html += `<div class="archive-name">${a.name} (${a.clips.length} clips)</div>`;
            html += '<table><thead><tr><th>#</th><th>ID</th><th>Inv No</th><th>File Name</th><th>Source In</th><th>Source Out</th><th>Duration</th><th>Link</th></tr></thead><tbody>';
            a.clips.forEach((c,i)=>{
                html += `<tr><td>${i+1}</td><td>${c.id||''}</td><td>${c.invNo||''}</td><td>${c.fileName||''}</td><td>${c.sourceIn||''}</td><td>${c.sourceOut||''}</td><td>${c.duration||'00:00:00:00'}</td><td>${c.link?`<a href="${c.link}">Link</a>`:''}</td></tr>`;
            });
            html += `<tr class="total-row"><td colspan="6"><strong>TOTAL</strong></td><td><strong>${a.duration}</strong></td><td></td></tr>`;
            html += '</tbody></table>';
        });
    }
    if (stills.length>0){
        html += '<div class="section-title">STILLS / IMAGES</div>';
        stills.forEach(a=>{
            html += `<div class="archive-name">${a.name} (${a.entries} stills)</div>`;
            html += '<table><thead><tr><th>#</th><th>ID</th><th>Inv No</th><th>File Name</th><th>Type</th><th>Link</th></tr></thead><tbody>';
            a.clips.forEach((c,i)=>{
                html += `<tr><td>${i+1}</td><td>${c.id||''}</td><td>${c.invNo||''}</td><td>${c.fileName||''}</td><td>Still Image</td><td>${c.link?`<a href="${c.link}">Link</a>`:''}</td></tr>`;
            });
            html += `<tr class="total-row"><td colspan="6"><strong>TOTAL: ${a.entries} Still Images</strong></td></tr>`;
            html += '</tbody></table>';
        });
    }
    html += '</body></html>';
    copyFormattedContent(html);
}

function copyFormattedContent(html){
    if (navigator.clipboard && navigator.clipboard.write){
        try{
            const tmp = document.createElement('div'); tmp.innerHTML = html;
            const htmlBlob = new Blob([html], {type:'text/html'});
            const textBlob = new Blob([tmp.innerText||tmp.textContent], {type:'text/plain'});
            const item = new ClipboardItem({'text/html':htmlBlob,'text/plain':textBlob});
            navigator.clipboard.write([item]).then(()=> alert('Table copied. You can paste in Word/Excel/Thunderbird.')).catch(()=> fallbackCopyHTML(html));
        }catch(e){ fallbackCopyHTML(html); }
    } else { fallbackCopyHTML(html); }
}
function fallbackCopyHTML(html){
    const div=document.createElement('div'); div.innerHTML=html; div.style.position='absolute'; div.style.left='-9999px'; div.style.top='-9999px'; div.style.opacity='0';
    document.body.appendChild(div);
    const sel=window.getSelection(); sel.removeAllRanges(); const r=document.createRange(); r.selectNodeContents(div); sel.addRange(r);
    try{ const ok=document.execCommand('copy'); document.body.removeChild(div); sel.removeAllRanges(); if(ok) alert('Table copied.'); else throw new Error('Copy failed'); }
    catch(err){ document.body.removeChild(div); sel.removeAllRanges(); alert('Copy failed. Try a modern browser.'); }
}

function exportToExcel(){
    if (typeof XLSX==='undefined') return alert('Excel library not loaded.');
    const data = (filteredData && filteredData.length>0) ? filteredData : archiveData;
    if (!data || data.length===0) return alert('No data to export.');

    try{
        const wb = XLSX.utils.book_new();
        const video = data.filter(a=>a.type==='video');
        const stills = data.filter(a=>a.type==='stills');

        const summary = [
            ['Archive Report Summary'], [''],
            ['Generated:', new Date().toLocaleString()]],
            nameRow = ['Sheet Name:', currentSheetName || 'N/A'];
        summary.push(nameRow);

        if (currentSheetInfo.production || currentSheetInfo.project || currentSheetInfo.episode || currentSheetInfo.name || currentSheetInfo.researcher || currentSheetInfo.contact){
            summary.push([''], ['SHEET INFORMATION']);
            if (currentSheetInfo.production) summary.push(['Production company:', currentSheetInfo.production]);
            if (currentSheetInfo.project) summary.push(['Film project:', currentSheetInfo.project]);
            if (currentSheetInfo.episode || currentSheetInfo.name) summary.push(['Episode:', currentSheetInfo.episode ? `${currentSheetInfo.episode} ${currentSheetInfo.name}` : currentSheetInfo.name]);
            if (currentSheetInfo.researcher) summary.push(['Researcher:', currentSheetInfo.researcher]);
            if (currentSheetInfo.contact) summary.push(['Contact:', currentSheetInfo.contact]);
        }

        summary.push([''], ['STATISTICS']);
        summary.push(['Video Archives:', video.length]);
        const clipCount = video.reduce((s,a)=>s+a.clips.length,0);
        summary.push(['Video Clips:', clipCount]);
        const totalFrames = video.reduce((s,a)=>s+a.totalFrames,0);
        summary.push(['Total Video Duration:', totalFrames>0 ? framesToTimecode(totalFrames,30) : '00:00:00:00']);
        const toBaseName = n=>!n?'':n.toString().trim().toLowerCase().replace(/\.[a-z0-9]+$/i,'');
        const unique = new Set(video.flatMap(a=>a.clips.map(c=>c.fileName)).filter(Boolean).map(toBaseName)).size;
        summary.push(['Unique Sources:', unique]);
        summary.push([''], ['Stills Archives:', stills.length]);
        summary.push(['Total Stills:', stills.reduce((s,a)=>s+a.entries,0)]);

        XLSX.utils.book_append_sheet(wb, XLSX.utils.aoa_to_sheet(summary), 'Summary');

        if (video.length>0){
            const rows = [['Archive','#','ID','Inv No','File Name','Source In','Source Out','Duration','Link']];

            video.forEach(a=>{
                rows.push([`${a.name} (${a.clips.length} clips)`,'','','','','','','','']);
                a.clips.forEach((c,i)=> rows.push(['', i+1, c.id||'', c.invNo||'', c.fileName||'', c.sourceIn||'', c.sourceOut||'', c.duration||'00:00:00:00', c.link||'']));
                rows.push(['','TOTAL','','','','','', a.duration,'']); rows.push(['']);
            });
            const ws = XLSX.utils.aoa_to_sheet(rows);
            ws['!cols']=[{wch:20},{wch:5},{wch:10},{wch:10},{wch:40},{wch:12},{wch:12},{wch:12},{wch:15}];
            XLSX.utils.book_append_sheet(wb, ws, 'Video Archives');
        }

        if (stills.length>0){
            const rows = [['Archive','#','ID','Inv No','File Name','Type','Link']];
            stills.forEach(a=>{
                rows.push([`${a.name} (${a.entries} stills)`,'','','','','','']);
                a.clips.forEach((c,i)=> rows.push(['', i+1, c.id||'', c.invNo||'', c.fileName||'', 'Still Image', c.link||'']));
                rows.push(['', `TOTAL: ${a.entries} Still Images`,'','','','','']); rows.push(['']);
            });
            const ws = XLSX.utils.aoa_to_sheet(rows);
            ws['!cols']=[{wch:20},{wch:5},{wch:10},{wch:10},{wch:50},{wch:15},{wch:15}];
            XLSX.utils.book_append_sheet(wb, ws, 'Stills');
        }

        const filename = (currentSheetName || 'archive-report') + '_' + new Date().toISOString().split('T')[0] + '.xlsx';
        XLSX.writeFile(wb, filename);
        alert('Excel file downloaded: ' + filename);
    }catch(e){ alert('Error creating Excel file: ' + e.message); }
}

window.onload = ()=> loadSavedSheets();
</script>
</body>
</html>
